\documentclass[12pt]{article}
\usepackage[utf8]{inputenc}
\usepackage{graphicx}
\usepackage{hyperref}
\usepackage{xcolor}
\usepackage{soul}
\usepackage[a4paper,width=150mm,top=25mm,bottom=25mm]{geometry}

\title{
{\includegraphics[width=3cm, height=2.5cm]{TechDoc/Cran.jpg}}
\\
\includegraphics[width=7cm, height=1cm]{TechDoc/TB.jpg}
\\
{Technical Documentation for TersectBrowser+}
}



\author{Extra author, David Oluwasusi, Tanya Stead, Gregory Lupton, Gabrielle Baumberg \\ Supervised by: Dr. Tomasz Kurowski}

\begin{document}
\sloppy % allows line spacing stretch to justify the text

\maketitle

\section{Overview}
This Technical Documentation describes the particular details of updating the original TersectBrowser developed by Tomasz Kurowski into the TersectBrowser+ by integrating multiple extension features.
\section{Architecture}
The TersectBrowser+ software is an Angular project, with an original frontend and backend written in Angular 8, and a separate extension space written in Angular 19 using Node 22. It was chosen to use a 'bolt-on' approach for the extensions in order to fit the project delivery within the time requirements, as well as allowing the new extensions to use up-to-date packages. The app is dockerized to allow both versions of node to be used seamlessly in different sections.

\section{Deployment}

\subsection{System Requirements}
TersectBrowser+ can be setup and deployed from both Mac and Windows machines, with variations in the configuration required. 


\section{TersectBrowser}
\section{TersectBrowser+}
\subsection{Variant Browser Extension}
\label{sec:Browser}
\subsubsection{Rationale}

\subsubsection{User Interface}

\paragraph{Feature Description}
\begin{itemize}
    \item Window is located at top of Tersect Browser (TB)- below settings bar but above TB heatmap 
    \item Jbrowse window (JB) layout - shows only sequence tracks and ruler track/linear genome scale. Zoom features/chromosome selection features have been removed from Jbrowse window. Hamburger button opens menu containing many options, notably track selector, where tracks can be added/removed. The chromosome scale for TB has a dynamic offset depending on the accession/tree view and the zoom level. This is synced between JB and TB, so that the chromosome scale lines up. 
    \begin{itemize}
        \item \hl{Layout TBC}: Set window size
    \end{itemize}
    \item Tracks:
    \begin{itemize}
        \item Reference sequence 
        \item Variant tracks for each loaded accession
        \item Gene models FeatureTrack (Ext-GM) 
    \end{itemize}
    \item Variant browser window is preloaded with default tracks. 
    \begin{itemize}
        \item \hl{Track TBC}: Currently pre-loaded with first 3 tracks from dataset. Should be changed to 1-2 meaningful accessions?
    \end{itemize}
    \item Syncing of the Browser pane and the Tersect heatmap pane, including the following:
    \begin{itemize}
        \item Zoom synced, both when the zoom plus/minus buttons are pressed, and also when scrolling the mouse to zoom. 
        \item Bin size changes synced.
        \item Interval synced using an offset of the Browser pane.
        \item Chromosome selection changes synced.
        \item Horizontal scrolling along the Browser and Tersect panes is synced.
    \end{itemize}
\end{itemize}
    
\subsubsection{Technical Description}

\paragraph{View State} 
The \verb +JBrowseLinearGenomeView+ component is imported from @jbrowse/react-linear-genome-view and is wrapped using React. The configurations for the assembly, assembly, and variant tracks, tracks, are imported from the respective assembly.ts and tracks.ts configuration files. The styling configurations, config, are imported from jbrowseConfig.ts. The \verb +JbrowseWrapperProps+ are imported from \verb +JbrowseInterface+. 

The function \verb +JbrowserWrapper+ takes as arguments the props from \verb +JbrowseWrapperProps+ and defines the \verb +viewState+. If an accession has been selected and the accession name is stored under \verb +props.location.accession.name+, the \verb +viewState+ defined in the constant \verb +JbrowseWithAccessionName+ is returned (See below parameters). If not, a conditional check verifies whether the props \verb +defaultInterval+ and \verb +offsetCanvas+ have been populated. If either of them are empty, a container with the phrase "Loadingâ€¦" is returned. If all data is present, the \verb +viewState+ is defined using the function \verb +createViewState+. This takes as arguments the following variables: 
\begin{itemize}
\item \verb +assembly+: the assembly track 
\item \verb +tracks+: the data tracks to display 
\item \verb +configuration+: the config variable where the theme is defined 
\item \verb +defaultSession+: an object of type LinearGenomeView, which defines the initial state. This object includes the following configurations: 
\begin{itemize}
\item \verb +bpPerPx+: the base pairs per pixel, which defines the bin size 
\item \verb +assemblyName+: the corresponding assembly for the track 
\item \verb +start+: the track start position 
\item \verb +end+: the track end position 
\item \verb +refName+: the genomic coordinates of the viewing window 
\end{itemize}
\end{itemize}

When no accession is selected in the Canvas interface, the first three tracks defined in \verb +tracks.ts+ are added to the \verb +viewState+. The dynamic left-hand offset is set by \verb +horizontalScroll()+. 


\paragraph{Assembly Config}

The configurations for the assembly track, which is built upon the reference accession SL2.50, is defined in \verb +assembly.ts+ in json format. The name is set to the reference accession name and \verb +trackId+ is set to "SL2.50-ReferenceSequenceTrack". The paths to the fasta file, along with its corresponding fasta index, are specified as local server URLs provided by the backend during the Tersect Browser setup. 

\paragraph{Tracks Config} 
The configurations for the \verb +VariantTrack+ and Gene Models \verb +FeatureTrack+ are defined in \verb +tracks.ts+ in json format. For the variant tracks, the \verb +name+ and \verb +trackId+ are set as the accession name, and for the Gene Models track these are set to "ITAG2.4 Gene Models".  The paths to the zipped files, along with its corresponding Tabix index files, are specified as local server URLs provided by the backend during the Tersect Browser setup. Each track is separated by a comma. 

\paragraph{Styling}
The container styling is defined in \verb +jbrowseConfig.ts+. The palette theme is set to colour '\#459e00' and the \verb +boxShadow+ is set to 'none'. 

\paragraph{Zoom} 
The zoom is synchronized between Tersect Browser and the JBrowse component. The \verb +zoomLevel+ observable is a component of the \verb +PlotStateService+ class. Inside \verb +tersect-browser.component.ts+, the subscription \verb +zoomSub+ listens to the \verb +zoomLevel+ observable and assigns the latest value to the component \verb +zoomLevel+. Inside \verb +tersect-browser.component.html+, the \verb +zoomLevel+ is passed to \verb +JbrowseWrapper+ as a prop and is used to define the \verb +bpPerPx+ in the \verb +viewState+. 

The bin size is synchronised in the same way: the \verb +binsize+ observable is a component of the \verb +PlotStateService+ class. Inside \verb +tersect-browser.component.ts+, the subscription \verb +binSizeSub+ listens to the \verb +binsize+ observable and assigns the latest value to the component \verb +binSize+. Inside \verb +tersect-browser.component.html+, the \verb +binSize+ is passed to \verb +JbrowseWrapper+ as a prop. 
Together, \verb +bpPerPx+ is calculated with the following equation: \begin{equation} bpPerPx = ((props.location.binSize) * (100 /props.location.zoomLevel)) \end{equation}


\paragraph{Chromosome selection}
The displayed chromosome is synced in a similar fashion to the zoom and bin size. The \verb +chromosome+ observable is a component of the \verb +PlotStateService+ class. Inside \verb +tersect-browser.component.ts+, the subscription \verb +chromosomeSub+ listens to the \verb +chromosome+ observable and assigns the latest value to the object \verb +selectedChromosomeSub+. Inside \verb +tersect-browser.component.html+, the \verb +selectedChromosomeSub+ is passed to \verb +JbrowseWrapper+ as the prop chromosome. Inside \verb +JbrowseWrapper+, the chromosome name is called from the chromosome object and used to define the \verb +refName+ in the \verb +viewState+. 

Additionally, the default chromosome that is pre-selected when Tersect Browser initially loads is passed to \verb +JbrowseWrapper+ and used to define the default \verb +viewState+. Inside \verb +tersect-browser.component.ts+, the variable \verb +preselectedChromosome+ is defined. On initializing, when the \verb +settings+ observer subscribes to the \verb +tersectBackendService+, the current \verb +plotState.chromosome+ is saved to the \verb +preselectedChromosome+ variable. This is then passed as the prop \verb +preselectedChromosome+ to \verb +JBrowseWrapper+ inside \verb +tersect-browser.component.html+.  Inside \verb +JbrowseWrapper+, the chromosome name is called from the \verb +preselectedChromosome+ object and used to define the \verb +refName+ in the default \verb +viewState+. 


\paragraph{Interval display}
The displayed interval is synced in a similar fashion to the zoom, bin size, and chromosome selection. The \verb +interval+ observable is a component of the \verb +PlotStateService+ class. Inside \verb +tersect-browser.component.ts+, the subscription \verb +selectedIntervalSub+ listens to the \verb +interval+ observable and assigns the latest value to the array \verb +selectedInterval+. Inside \verb +tersect-browser.component.html+, the \verb +selectedInterval+ is passed to \verb +JbrowseWrapper+ as the prop \verb +selectedInterval+. Inside \verb +JbrowseWrapper+, the first element of the array is used to define the start position in the \verb +viewState+, and the second element is used to define the end position. 
Additionally, the default interval that is pre-selected when Tersect Browser initially loads is passed to \verb +JbrowseWrapper+ and used to define the default \verb +viewState+. Inside \verb +tersect-browser.component.ts+, the variable \verb +defaultInterval+ is defined. On initializing, the method \verb +generateMissingSettings+ loads the interval based on the size of the selected chromosome, which is obtained from \verb +BrowserSettings+. The interval is saved as an array to \verb +defaultInterval+ and inside \verb +tersect-browser.component.html+ it is passed as the prop \verb +defaultInterval+ to \verb +JbrowseWrapper+. Inside \verb +JbrowseWrapper+, the first element of the array is used to define the start position in the default \verb +viewState+, and the second element is used to define the end position. 

\paragraph{Offset}
The dynamic offset is synced in a similar fashion to zoom, bin size, chromosome selection, and interval. The observable \verb +offsetCanvas+ is defined as a component of the \verb +PlotStateService+ class. The public variable \verb +offsetCanvasSource+ is defined as an instance of the \verb +BehaviourSubject+ class and holds all recorded values of the canvas offset. In the class constructor, \verb +offsetCanvas+ is initialised to continuously hold the latest value from \verb +offsetCanvasSource+. The canvas offset is set in the \verb +TreePlotComponent+ class, and is passed to \verb +offsetCanvasSource+ when the tree is redrawn. 

Inside \verb +tersect-browser.component.ts+, the variable \verb +offsetCanvas+ is defined, and the subscription \verb +offsetCanvasSub+ listens to the  \verb +offsetCanvas+ observable and assigns the latest value to \verb +offsetCanvas+. Inside \verb +tersect-browser.component.html+, the \verb +offsetCanvas+ is passed to \verb +JbrowseWrapper+ as the prop \verb +offsetCanvas+. Inside \verb +JbrowseWrapper+, the variable defines the extent of the \verb +horizontalScroll+ using the following logic: $horizontalScroll(-(location.offsetCanvas - 4))$. 


\subsubsection{Test Results}
When additional variant tracks are added to the Browser view, the size of the browser panel does not change. The user is able to scroll downwards to view more tracks in the browser. 

\subsubsection{Future Improvements}
(Current) Limitations: 

Only SL2.50 loaded as assembly and reference 

Can only view variant tracks for 150\_VCF\_Tomato dataset - this is hard coded, and would need to be changed if we want this to be dynamic (when the user adds their own dataset) / if we as admins want to load soybean dataset!

\subsection{Gene Models Extension}
\label{sec:Models}
\subsubsection{Rationale}
\subsubsection{User Interface}
\paragraph{Feature Description}
\begin{itemize}
    \item In the Jbrowse window, the first track shows gene models based on the GFF file provided.  
    \item Gene model annotations are based on the official \hl{tomato genome annotation v2.4}: \href{https://phytozome-next.jgi.doe.gov/info/Slycopersicum_ITAG2_4#:~:text=Genome%20Overview,genome%2Cwith%2034%2C725%20gene%20models}{Slycopersicum ITAG annotation v2.4}
    \item The popup view of the same Jbrowse component has similar default: the first track is the gene models track, and the second track is the variant track for the selected accession.
\end{itemize}

\subsubsection{Technical Description}
The configuration for the Gene Models \verb+FeatureTrack+ is defined as the first entry in \verb+tracks.ts+. The paths to the sorted and compressed GFF file, along with its corresponding Tabix index, are specified as local server URLs provided by the backend during the Tersect Browser setup. 

The Jbrowse \verb+viewState+ is configured in \verb+JbrowseWrapper.tsx+, as described in Extension-JBrowse. If no accession is selected, the first three tracks stored in \verb+tracks.ts+ are added to the \verb+viewState+. As the Gene Models \verb+FeatureTrack+ is the first track in \verb+tracks.ts+, it is displayed as the first track in the Jbrowse window. 

For the popup window, the JBrowse \verb+viewState+ is configured when an accession is selected in \verb+JbrowseWithAccession.tsx+, as described in \nameref{sec:Browser}. If a track with a \verb+trackId+ matching the selected accession is found, the viewer displays both the first track defined in \verb+tracks.ts+ and the matching track. 

\subsubsection{Test Results}
\subsubsection{Future Improvements}

\subsection{Feature Search Extension}
\subsubsection{Rationale}
The aim of this extension is to allow the user to search specific genes and identify which accession contains a high/medium/low impact variant impacting that gene.
\subsubsection{User Interface}
\paragraph{Feature Description}
\begin{itemize}
    \item Separate search bar in the top right of the tersect browser header where user can input gene name and search button 
    \item \hl{TBC: Option} for user to select based on region in addition to gene name 
    \item Popup window for user to select advanced features 
    \item Output: Bins in the canvas are highlighted red at the chromosomal position where the gene is located, and only for accessions containing a variant impacting that gene 
    \item Clear button to clear highlighted bins from canvas 
\end{itemize}
\subsubsection{Technical Description}
\paragraph{\hl{Search Bar}}
\paragraph{\hl{Popup window with advanced settings }}
\paragraph{Highlighting bins}
Bin highlighting is controlled in the \verb+bin-draw.service+ by two functions. The first function, \verb+highlightFeatureBins()+, is defined, taking as arguments a string containing accession names, the bin position along the x-axis, and the \verb+binView+. First, the y-axis bin position for accession names is calculated. Then, the \verb+binView+ is redrawn in greyscale, with the bin colour determined by the difference to the reference accession. Using the x-axis \verb+binIndex+ position and the y-axis accession bin positions, these bins are coloured red in the \verb+binView+. The modified \verb+binView+ is returned as the output. The second function, \verb+highlightBins()+, takes as arguments the start position of the interval and the bin size currently shown in the Tersect pane, a list of ordered accessions shown in the canvas, and the searched accessions. For each searched accession, accession name is reformatted to match the format displayed in the Tersect pane. Then, the bin position along the x-axis is calculated using the \verb+getBinIndexFromPosition()+ function, which takes as arguments the feature position along the chromosome, the interval start position, and the bin size. Then, \verb+highlightFeatureBins()+ is called for each accession. Lastly, the canvas is redrawn using the modified \verb+binView+ output from \verb+highlightFeatureBins()+. 
\begin{itemize}
    \item highlightFeatureBins(accessions: string[], binIndex: number, binView: DistanceBinView) - takes a string of accession names, a binIndex (corresponding to the bin position along the x-axis matching the gene position on the chromosome), and binView. The y-axis index for bins matching accession names in the accessions strings is calculated and combined with the binIndex to colour these specific bins red. The rest of the bins are coloured in greyscale, with saturation depending on binDistance (calculated from tersect on the backend 
    \begin{itemize}
        \item Bin-draw.service.ts 
        \item Called by highlightBins() in bin-draw.service.ts 
    \end{itemize}
    \item highlightBins(intervalStart, binsize, orderedAccessions, searchedAccessions) - takes selected interval start position, selected binSize, list of ordered accessions shown in the canvas, and searched accessions (passed from callback function?). Accession names in Jbrowse are in a different format to what is stored in tersect browser, so accession names are reformatted to match tersect browser bins. binIndex is calculated for the selected gene. These two are passed to highlightFeatureBins() - along with this.bins - to highlight the bins. The canvas is then redrawn using the binView calculated in highlightFeatureBins(). 
    \begin{itemize}
        \item Bin-draw.service.ts 
        \item Called by callHighlightBins() in tersect-browser.component.ts 
    \end{itemize}
    \item callHighlightBins(searchedAcessions) - takes searchedAccessions. Calls highlightBins(), passing along  selected interval start position, selected binSize, list of ordered accessions shown in the canvas, and searched accessions (passed from callback function?). 
    \begin{itemize}
        \item Tersect-browser.component.ts 
    \end{itemize}
\end{itemize}
 
\paragraph{Calling Highlighting Bins} \mbox{}
\\
\hl{TBC: Mechanism} of searching VCFs to identify variants 

Finally, callHighlightBins() is called, which itself calls highlightBins() from the bin-draw.service, passing as arguments the current interval start position, binsize, displayed accessions in an ordered format, and the searched accessions.  
\paragraph{\hl{Clear Button }}
 

\subsubsection{Test Results}
\subsubsection{Future Improvements}
\subsection{Barcode Generation Extension}
\subsubsection{Rationale}
\subsubsection{User Interface}
\paragraph{Feature Description}
Given input parameters specified by the user, barcodes are generated via the backend and automatically downloaded for the user in txt format. The downloaded file is titled in the following format for easy identification and to prevent files being overwritten: \textit{SystemDateAndTime\_TB\_Barcode\_Gen\_AccessionName\.txt}.

The file contains the following information: 
\begin{itemize}
    \item \textbf{Barcode sequence} - The base with the accession-specific SNP is enclosed in square brackets
    \item \textbf{Barcode Start \& Barcode End} - The absolute position of the barcode in the chromosome 
    \item \textbf{Variant Count} - The number of accession-specific SNPs that are present in the barcode 
    \item \textbf{Variant Position} - The relative position of the accession-specific SNPs in the barcode 
    \item \textbf{Repeat Sequence} - The sequence of the 2-bp repeating region. A repeating region is defined as 2 base pairs repeating 3+ times 
    \item \textbf{Repeat Multiplier} - The number of times the repeat sequence is repeated 
    \item \textbf{Repeat Start-End} - the relative start and end position of the repeat region within the barcode sequence 
    \item \textbf{GC Content} - The GC content of the barcode 
\end{itemize}

\subsubsection{Technical Description}

Barcode generation is controlled by two scripts: \verb+barcode_finder.sh+ and \verb+find_barcode.py+. 

\paragraph{Calling Tersect CLI to extract variants}: 
\verb+Barcode_finder.sh+ is run on the command line, and takes as input accession name, chromosome, interval start position, interval end position, barcode size, maximum variant number, reference fasta, and tersect TSI index. The chromosome and interval start and end positions are used to define the searchable \verb+REGION+, and the accession name is used to define \verb+SAFE_ACC+ which is used to save files to a temporary file.  

The tersect CLI command \verb+tersect view+  is called to extract all variants within the specified region for the specified accession. The output is saved as a temporary TSV file as: \verb+${SAFE_ACC}_acc_unique.tsv+. The tersect CLI command tersect view is again used to extract all variants within the specified region for all accessions except the specified accession. This output is saved as a temporary TSV file as: \verb+${SAFE_ACC}_union_vars.tsv+.  

Lastly, the \verb+find_barcode.py+ file is called, passing as arguments the accession name, reference fasta, chromosome, interval start position, interval end position, barcode size, maximum variant number, and the tersect output files  \verb+${SAFE_ACC}_acc_unique.tsv+ and  \verb+${SAFE_ACC}_union_vars.tsv+. 

\paragraph{Generating barcodes}: 
\verb+Find_barcode.py+ requires the following dependencies: argparse, SeqIO, and datetime.  

The reference fasta is parsed using \verb+SeqIO.parse+, yielding sequence records that are converted to a dictionary using \verb+SeqIO.dict+. Using the user-inputted chromosome name, \verb+[args.chrom].seq+ extracts the chromosome sequence from the dictionary and saves it to the variable ref. The user-defined interval start and end positions are used to extract the \verb+ref_window+ from ref. 

The \verb+load_variant_file()+ method imports the tersect output files and creates a dictionary, with variant position being stored as the key and a tuple containing the original base and the alternate base being stored as the dictionary value. Then, the \verb+remove_overlapping_variants()+ method compares the dictionaries and creates a new dictionary \verb+new_unique_vars+ with the same format, containing variants that are only present in the specified accession and not also present in any other accession. The method \verb+apply_variants_to_sequence()+ then uses the \verb+ref_window+ and \verb+new_unique_vars+ to generate an accession-specific sequence, \verb+unique_seq+, containing accession-specific SNPs. Lastly, the \verb+find_barcode_windows()+ method compares \verb+unique_seq+ against \verb+ref_window+ and using a sliding window of 1 base pair, identifies regions where the two sequences differ. The sequence, along with the absolute start and end position, is saved to the variable barcodes.  

\paragraph{Output file and barcode stats}: 
Statistical metrics are calculated for each barcode, using custom methods. The number of accession-specific variants is calculated using \verb+count_variant_number()+, which also records variant position within the barcode. The variant position is used to highlight the variants within the barcode using the custom \verb+highlight_ref_alt_positions()+ method, which encloses the variant in the following format: \verb+[original base/alternate base]+. Repeat content is calculated using \verb+find_dinucleotide_repeats_custom()+, with repeats being defined as regions where a dinucleotide (2-base pair) sequence repeats consecutively three or more times. The repeating dinucleotide, number of times the dinucleotide repeats, and the start and end positions of the repeat region within the barcode are returned. GC content is calculated as a percentage to six decimal places using \verb+calculate_gc_content()+. 

The barcodes and respective metrics are written to a tsv file. The file name is formatted to include system date and time, \verb+'TB_Barcode_Gen'+, and the specified accession. 

\subsubsection{Test Results}
\subsubsection{Future Improvements}
\subsection{Future Work and Extension Design}
\subsubsection{Automated Introgression Search Extension}
\section{References}

\subsection{Purpose}
Identify the purpose of this SDD and its intended audience. (e.g. This software design
document describes the architecture and system design of XX.. ).


\subsection{Scope}
Provide a description and scope of the software and explain the goals, objectives and benefits
of your project. This will provide the basis for the brief description of your product.


\subsection{Overview}
Provide an overview of this document and its organization.



\subsection{Reference Material}
This section is optional.
List any documents, if any, which were used as sources of information for the test plan. 


\subsection{Definitions and Acronyms}
This section is optional.
Provide  definitions of all terms, acronyms, and  abbreviations that might exist to  properly 
interpret the SDD. These definitions should be items used in the SDD that are most likely not 
known to the audience.

\begin{table}[h]
\begin{tabular}{|l|l|}
\hline
\multicolumn{1}{|c|}{\textbf{Term}} & \multicolumn{1}{c|}{\textbf{Definition}}                                                                                              \\ \hline
Software Design Document (SDD)      & \begin{tabular}[c]{@{}l@{}}Used as the primary medium for communicating software \\ design information.\end{tabular}                  \\ \hline
Design Entity                       & \begin{tabular}[c]{@{}l@{}}An element of a design that is structurally and functionally \\ distinct from other elements.\end{tabular} \\ \hline
\end{tabular}
\end{table}

\section{System Overview}
Give a general description of the functionality, context and design of your project. Provide any 
background information if necessary.

\section{System Architecture}
\subsection{Architectural Design}


\subsection{Decomposition Description}

\subsection{Design Rationale}


\section{Data Design}
\subsection{Data Description}

\subsection {Data Dictionary}

\section{Component Design}

\section{Humnan Interface Design}

\subsection {Overview of User Interface}

\subsection {Screen Images}

\subsection {Screen Objects and Actions}

\section{APPENDICES}

\section {References}


\end{document}
